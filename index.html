<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Artisan Stock Sales Tracker</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f7fa;
      margin: 0;
      padding: 20px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    header img {
      width: 50px;
      height: 50px;
    }
    h1 {
      color: #222;
      font-size: 24px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
    }
    th, td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: left;
      cursor: pointer;
    }
    th {
      background-color: #2c3e50;
      color: #fff;
      user-select: none;
    }
    input, select, button {
      padding: 10px;
      margin: 6px 0;
      width: 100%;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .form-container, .filter-container, .recycle-bin-container {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .submit-btn, .download-btn, .clear-btn, .restore-btn, .delete-btn {
      background-color: #2c3e50;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
    }
    .submit-btn:hover, .download-btn:hover, .clear-btn:hover, .restore-btn:hover, .delete-btn:hover {
      background-color: #34495e;
    }
    .responsive-table-wrapper {
      overflow-x: auto;
      max-height: 400px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .total-sales {
      font-size: 16px;
      font-weight: bold;
      margin-top: 10px;
    }
    .recycle-bin-list {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 10px;
    }
    .recycle-bin-list div {
      border-bottom: 1px solid #ddd;
      padding: 8px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .recycle-bin-list button {
      background-color: #e74c3c;
      margin-left: 10px;
      font-size: 12px;
      padding: 5px 8px;
    }
    .recycle-bin-list button:hover {
      background-color: #c0392b;
    }
    @media (max-width: 600px) {
      table {
        font-size: 14px;
      }
      .form-container, .filter-container, .recycle-bin-container {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo" />
    <h1>Demo Stock Sales Tracker with Recycle Bin</h1>
  </header>

  <div class="form-container">
    <form id="salesForm">
      <label>Order Number: <input type="text" id="orderNumber" required /></label><br />
      <label>Item Name: <input type="text" id="itemName" required /></label><br />
      <label>Quantity: <input type="number" id="quantity" value="1" min="1" required /></label><br />
      <label>Date Sold: <input type="date" id="dateSold" required /></label><br />
      <label>Sold By: <input type="text" id="soldBy" required /></label><br />
      <label>Platform: <input type="text" id="platform" required /></label><br />
      <label>Customer Name: <input type="text" id="customerName" /></label><br />
      <label>Contact: <input type="text" id="contact" /></label><br />
      <label>Price (ZAR): <input type="number" id="price" required /></label><br />
      <label>Payment Method: <input type="text" id="paymentMethod" /></label><br />
      <label>Notes: <input type="text" id="notes" /></label><br />
      <button type="submit" class="submit-btn">Add Entry</button>
    </form>
  </div>

  <div class="filter-container">
    <label>From Date: <input type="date" id="fromDate" /></label>
    <label>To Date: <input type="date" id="toDate" /></label>
    <button class="download-btn" onclick="downloadExcel()">Download Sales Report</button>
    <button class="clear-btn" onclick="clearAllData()">Clear All Data</button>
    <button class="download-btn" onclick="calculateTotal()">Show Total Sales (ZAR)</button>
    <div class="total-sales" id="totalDisplay"></div>
  </div>

  <div class="responsive-table-wrapper">
    <table id="salesTable">
      <thead>
        <tr>
          <th data-key="dateSold">Date Sold ▼</th>
          <th data-key="orderNumber">Order Number</th>
          <th data-key="itemName">Item Name</th>
          <th data-key="quantity">Quantity</th>
          <th data-key="soldBy">Sold By</th>
          <th data-key="platform">Platform</th>
          <th data-key="customerName">Customer Name</th>
          <th data-key="contact">Contact</th>
          <th data-key="price">Price (ZAR) ▼</th>
          <th data-key="paymentMethod">Payment Method</th>
          <th data-key="notes">Notes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="recycle-bin-container">
    <h2>Recycle Bin</h2>
    <button class="restore-btn" onclick="restoreAll()">Restore All</button>
    <button class="delete-btn" onclick="deleteAllRecycleBin()">Delete All Permanently</button>
    <div class="recycle-bin-list" id="recycleBinList">
      <!-- Deleted entries appear here -->
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // Your Firebase config here:
  const firebaseConfig = {
    apiKey: "AIzaSyDAIhZkP8hZeNyTMHbjyiWRSJMcnk0hMlM",
    authDomain: "salesreportapp-57f0c.firebaseapp.com",
    projectId: "salesreportapp-57f0c",
    storageBucket: "salesreportapp-57f0c.firebasestorage.app",
    messagingSenderId: "800995695454",
    appId: "1:800995695454:web:c7169d10344a2a23bf4dcf",
    measurementId: "G-T1SVRVTLQW"
  };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Collections
    const salesCol = db.collection('salesData');
    const recycleBinCol = db.collection('recycleBin');

    let salesData = [];
    let recycleBinData = [];
    let sortState = {
      key: 'dateSold',
      asc: true
    };

    // DOM refs
    const salesTableBody = document.querySelector('#salesTable tbody');
    const recycleBinList = document.getElementById('recycleBinList');
    const totalDisplay = document.getElementById('totalDisplay');

    // Initialize: load sales and recycle bin data from Firestore
    async function loadData() {
      // Load sales data
      const salesSnapshot = await salesCol.get();
      salesData = salesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      // Load recycle bin data
      const recycleSnapshot = await recycleBinCol.get();
      recycleBinData = recycleSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      renderSalesTable();
      renderRecycleBin();
      calculateTotal();
    }

    // Render sales table with sorting and filtering (filter by date)
    function renderSalesTable() {
      salesTableBody.innerHTML = '';
      let filtered = salesData;

      const from = document.getElementById('fromDate').value;
      const to = document.getElementById('toDate').value;

      if (from) filtered = filtered.filter(item => item.dateSold >= from);
      if (to) filtered = filtered.filter(item => item.dateSold <= to);

      // Sort
      filtered.sort((a, b) => {
        let valA = a[sortState.key];
        let valB = b[sortState.key];
        if(sortState.key === 'price' || sortState.key === 'quantity'){
          valA = Number(valA);
          valB = Number(valB);
        }
        if (valA < valB) return sortState.asc ? -1 : 1;
        if (valA > valB) return sortState.asc ? 1 : -1;
        return 0;
      });

      filtered.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.dateSold}</td>
          <td>${item.orderNumber}</td>
          <td>${item.itemName}</td>
          <td>${item.quantity}</td>
          <td>${item.soldBy}</td>
          <td>${item.platform}</td>
          <td>${item.customerName}</td>
          <td>${item.contact}</td>
          <td>R${parseFloat(item.price).toFixed(2)}</td>
          <td>${item.paymentMethod}</td>
          <td>${item.notes}</td>
          <td><button onclick="deleteSale('${item.id}')">Delete</button></td>
        `;
        salesTableBody.appendChild(tr);
      });
    }

    // Render recycle bin list
    function renderRecycleBin() {
      recycleBinList.innerHTML = '';
      if (recycleBinData.length === 0) {
        recycleBinList.textContent = 'Recycle bin is empty.';
        return;
      }
      recycleBinData.forEach(item => {
        const div = document.createElement('div');
        div.textContent = `${item.dateSold} - ${item.itemName} - R${parseFloat(item.price).toFixed(2)}`;
        const restoreBtn = document.createElement('button');
        restoreBtn.textContent = 'Restore';
        restoreBtn.onclick = () => restoreSale(item.id);

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.style.backgroundColor = '#c0392b';
        deleteBtn.onclick = () => deleteRecycleBinSale(item.id);

        div.appendChild(restoreBtn);
        div.appendChild(deleteBtn);
        recycleBinList.appendChild(div);
      });
    }

    // Add a sale
    document.getElementById('salesForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const sale = {
        orderNumber: document.getElementById('orderNumber').value.trim(),
        itemName: document.getElementById('itemName').value.trim(),
        quantity: Number(document.getElementById('quantity').value),
        dateSold: document.getElementById('dateSold').value,
        soldBy: document.getElementById('soldBy').value.trim(),
        platform: document.getElementById('platform').value.trim(),
        customerName: document.getElementById('customerName').value.trim(),
        contact: document.getElementById('contact').value.trim(),
        price: Number(document.getElementById('price').value),
        paymentMethod: document.getElementById('paymentMethod').value.trim(),
        notes: document.getElementById('notes').value.trim(),
      };

      await salesCol.add(sale);
      salesData.push(sale); // Keep local in sync
      await loadData(); // Refresh table & recycle bin

      e.target.reset();
    });

    // Delete sale: move to recycle bin
    async function deleteSale(id) {
      if (!confirm("Are you sure you want to delete this sale? It will go to recycle bin.")) return;

      const sale = salesData.find(s => s.id === id);
      if (!sale) return;

      await recycleBinCol.add(sale);
      await salesCol.doc(id).delete();

      await loadData();
    }

    // Clear all data: move all sales to recycle bin
    async function clearAllData() {
      if (!confirm("Clear ALL sales data? This moves all records to recycle bin.")) return;

      const batch = db.batch();

      salesData.forEach(sale => {
        const saleRef = salesCol.doc(sale.id);
        const binRef = recycleBinCol.doc(); // New doc in recycle bin
        batch.set(binRef, sale);
        batch.delete(saleRef);
      });

      await batch.commit();
      await loadData();
    }

    // Restore sale from recycle bin
    async function restoreSale(id) {
      const sale = recycleBinData.find(s => s.id === id);
      if (!sale) return;

      await salesCol.add(sale);
      await recycleBinCol.doc(id).delete();

      await loadData();
    }

    // Delete one from recycle bin permanently
    async function deleteRecycleBinSale(id) {
      if (!confirm("Delete this record permanently?")) return;

      await recycleBinCol.doc(id).delete();
      await loadData();
    }

    // Restore all from recycle bin
    async function restoreAll() {
      if (!confirm("Restore ALL items from recycle bin?")) return;

      const batch = db.batch();
      recycleBinData.forEach(item => {
        const saleRef = salesCol.doc(); // New sale doc
        const binRef = recycleBinCol.doc(item.id);

        batch.set(saleRef, {
          orderNumber: item.orderNumber,
          itemName: item.itemName,
          quantity: item.quantity,
          dateSold: item.dateSold,
          soldBy: item.soldBy,
          platform: item.platform,
          customerName: item.customerName,
          contact: item.contact,
          price: item.price,
          paymentMethod: item.paymentMethod,
          notes: item.notes
        });
        batch.delete(binRef);
      });

      await batch.commit();
      await loadData();
    }

    // Delete all permanently from recycle bin
    async function deleteAllRecycleBin() {
      if (!confirm("Delete ALL recycle bin items permanently?")) return;

      const batch = db.batch();
      recycleBinData.forEach(item => {
        const binRef = recycleBinCol.doc(item.id);
        batch.delete(binRef);
      });

      await batch.commit();
      await loadData();
    }

    // Calculate total sales in current filter
    function calculateTotal() {
      const from = document.getElementById('fromDate').value;
      const to = document.getElementById('toDate').value;
      let total = 0;
      salesData.forEach(item => {
        if ((!from || item.dateSold >= from) && (!to || item.dateSold <= to)) {
          total += Number(item.price);
        }
      });
      totalDisplay.textContent = `Total Sales (ZAR): R${total.toFixed(2)}`;
    }

    // Sort table columns when header clicked
    document.querySelectorAll('#salesTable th[data-key]').forEach(th => {
      th.addEventListener('click', () => {
        const key = th.getAttribute('data-key');
        if (sortState.key === key) {
          sortState.asc = !sortState.asc;
        } else {
          sortState.key = key;
          sortState.asc = true;
        }
        // Update arrow indicators on headers
        document.querySelectorAll('#salesTable th[data-key]').forEach(header => {
          header.textContent = header.textContent.replace(/[\u25B2\u25BC]/g, '');
          if(header.getAttribute('data-key') === sortState.key){
            header.textContent += sortState.asc ? ' ▼' : ' ▲';
          }
        });
        renderSalesTable();
      });
    });

    // On date filter change re-render
    document.getElementById('fromDate').addEventListener('change', renderSalesTable);
    document.getElementById('toDate').addEventListener('change', renderSalesTable);

    // Load initial data on page load
    loadData();

  </script>
</body>
</html>
